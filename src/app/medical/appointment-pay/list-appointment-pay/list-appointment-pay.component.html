<!-- eslint-disable @angular-eslint/template/label-has-associated-control -->
<!-- eslint-disable @angular-eslint/template/eqeqeq -->
<div class="page-wrapper">
  <div class="content">

    <!-- Page Header -->
    <div class="page-header">
      <div class="row">
        <div class="col-sm-12">
          <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="#" onclick="return false;">Appointment Pays </a></li>
            <li class="breadcrumb-item"><i class="feather icon-chevron-right"></i></li>
            <li class="breadcrumb-item active">Pays</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- /Page Header -->

    <div class="row">
      <div class="col-sm-12">

        <div class="card card-table show-entire">
          <div class="card-body">

            <!-- Table Header -->
            <div class="page-table-header mb-2">
              <div class="row align-items-center">
                <div class="col">
                  <div class="doctor-table-blk">
                    <h3>Pays</h3>
                    <!-- <div class="doctor-search-blk">
                      <div class="top-nav-search table-search-blk">
                        <input type="text" class="form-control" placeholder="Search here" [(ngModel)]="searchDataValue"
                          (ngModelChange)="searchData(searchDataValue)">
                        <a class="btn"><img src="assets/img/icons/search-normal.svg" alt=""></a>
                      </div>
                      <div class="add-group">

                        <a href="javascript:;" class="btn btn-primary doctor-refresh ms-2"><img
                            src="assets/img/icons/re-fresh.svg" alt=""></a>
                      </div>
                    </div> -->
                  </div>
                </div>
                <div class="col-auto text-end float-end ms-auto download-grp">
                  <a href="javascript:;" class=" me-2"><img src="assets/img/icons/pdf-icon-01.svg" alt=""></a>
                  <a href="javascript:;" class=" me-2"><img src="assets/img/icons/pdf-icon-02.svg" alt=""></a>
                  <a href="javascript:;" class=" me-2"><img src="assets/img/icons/pdf-icon-03.svg" alt=""></a>
                  <a href="javascript:;"><img src="assets/img/icons/pdf-icon-04.svg" alt=""></a>

                </div>
              </div>
            </div>
            <!-- /Table Header -->
            <div class="staff-search-table">
              <form>
                <div class="row">
                  <div class="col-12 col-md-6 col-xl-4">
                    <div class="form-group local-forms">
                      <label for="Employee">Doctor </label>
                      <input class="form-control" [(ngModel)]="searchDataDoctor" name="searchDataDoctor" type="text">
                    </div>
                  </div>
                  <div class="col-12 col-md-6 col-xl-4">
                    <div class="form-group local-forms">
                      <label for="Employee">Paciente </label>
                      <input class="form-control" [(ngModel)]="searchDataValue" name="searchDataValue" type="text">
                    </div>
                  </div>
                  <div class="col-12 col-md-6 col-xl-4">
                    <div class="form-group local-forms">
                      <label for="Role">Especialidad </label>
                      <mat-select [(ngModel)]="specialitie_id" [ngModelOptions]="{standalone: true}"
                        class="form-control select" placeholder="Select especialidad">
                        <mat-option *ngFor="let data of specialities" [value]="data.id">
                          {{data.name}}
                        </mat-option>
                      </mat-select>
                    </div>
                  </div>
                  <!-- <div class="col-12 col-md-6 col-xl-4">
                                      <div class="form-group local-forms">
                                          <label for="Leave">Leave Status </label>
                                          <mat-select [(ngModel)]="selectedValue" [ngModelOptions]="{standalone: true}" class="form-control select"  placeholder="Select Leave Status">
                                            <mat-option *ngFor="let data of selectedList2" [value]="data.value">
                                            {{data.value}}
                                            </mat-option>
                                        </mat-select>
                                      </div>
                                  </div> -->
                  <div class="col-12 col-md-6 col-xl-4">
                    <div class="form-group local-forms">
                      <label>From </label>
                      <!-- <input class="form-control datetimepicker" [(ngModel)]="date_start" name="date_start" type="text" matInput [matDatepicker]="picker1" >
                                        <mat-datepicker #picker1></mat-datepicker>
                                        <mat-datepicker-toggle matIconSuffix [for]="picker1"></mat-datepicker-toggle> -->
                      <input class="form-control datetimepicker" [(ngModel)]="date_start" name="date_start" type="date">
                    </div>
                  </div>
                  <div class="col-12 col-md-6 col-xl-4">
                    <div class="form-group local-forms">
                      <label>To </label>
                      <!-- <input class="form-control datetimepicker" [(ngModel)]="date_end" name="date_end" type="text" matInput [matDatepicker]="picker2"  >
                                        <mat-datepicker #picker2></mat-datepicker>
                                        <mat-datepicker-toggle matIconSuffix [for]="picker2"></mat-datepicker-toggle> -->
                      <input class="form-control datetimepicker" [(ngModel)]="date_end" name="date_end" type="date">
                    </div>
                  </div>
                  <div class="col-12 col-md-6 col-xl-4">
                    <div class="doctor-submit">
                      <button type="button" class="btn btn-primary submit-list-form me-2"
                        (click)="searchData()">Buscar</button>
                    </div>
                  </div>
                </div>
              </form>
            </div>

            <div class="table-responsive">
              <table matSort (matSortChange)="sortData($event)"
                class="table border-0 custom-table comman-table datatable mb-0">
                <thead>
                  <tr>
                    <th mat-sort-header="name">Doctor</th>
                    <th mat-sort-header="email">Paciente</th>
                    <th mat-sort-header="mobile">Fecha</th>
                    <th mat-sort-header="birth_date">Hora</th>
                    <th mat-sort-header="n_document">Especialidad</th>
                    <th mat-sort-header="state">Estado Pago</th>
                    <th mat-sort-header="created_at">Costo Cita</th>
                    <!-- <th></th> -->
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngFor="let data of appointmentList">
                    <tr>
                      <td>{{ data.doctor.full_name }}</td>
                      <td>{{ data.patient.full_name }}</td>
                      <td>{{ data.date_appointment_format | date: 'dd-MM-yyyy' }}</td>
                      <td>{{ data.segment_hour.format_segment.format_hour_start + ' - ' +
                        data.segment_hour.format_segment.format_hour_end }}</td>
                      <td>{{ data.specialitie.name }}</td>
                      <td>
                        <button
                          [ngClass]="{'status-green' : data.status_pay === 1, 'status-pink' : data.status_pay === 2}"
                          class="custom-badge">{{data.status_pay == 1 ? 'Pagado' : 'Deuda'}}</button>
                      </td>

                      <td>$ {{ data.amount | number: '1.2-2' }}</td>

                    </tr>

                    <tr *ngFor="let payment of data.payments; let i = index" style="border-bottom: 1px solid #2e37a4;">
                      <td></td>
                      <td>
                        <button class="btn btn-success" data-bs-toggle="modal" *ngIf="i == 0"
                          [attr.data-bs-target]="'#add_payment-'+data.id" (click)="clearData()">Nuevo Pago</button>
                      </td>
                      <td></td>
                      <td>#{{ payment.id }}</td>
                      <td>{{ payment.method_payment }}</td>
                      <!-- AquÃ­ se muestra el saldo restante -->
                      <td>
                        $ {{ payment.amount | number: '1.2-2' }} |
                        $ {{ (data.amount - getTotalPaid(data.payments, i + 1)) | number: '1.2-2' }}
                      </td>
                      <td>
                        <div class="dropdown dropdown-action">
                          <a href="javascript:void(0);" class="action-icon dropdown-toggle" data-bs-toggle="dropdown"
                            aria-expanded="false"><i class="fa fa-ellipsis-v"></i></a>
                          <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="javascript:void(0);" data-bs-toggle="modal"
                              [attr.data-bs-target]="'#edit_payment-'+data.id" (click)="selectEditPayment(payment)"><i
                                class="fa-solid fa-pen-to-square m-r-5"></i> Editar</a>
                            <a class="dropdown-item" href="javascript:void(0);" (click)="selectEditPayment(payment)"
                              data-bs-toggle="modal" [attr.data-bs-target]="'#delete_payment-'+payment.id"><i
                                class="fa fa-trash-alt m-r-5"></i> Eliminar</a>
                          </div>
                        </div>
                        <!-- Modal delete -->
                        <div [attr.id]="'delete_payment-'+payment.id" class="modal fade delete-modal" role="dialog">
                          <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                              <div class="modal-body text-center">
                                <img src="assets/img/sent.png" alt="" width="50" height="46">
                                <div class="modal-body d-flex">
                                  <h3 *ngIf="payment_selected" class="text-wrap">Â¿EstÃ¡s segura de que quieres eliminar
                                    este
                                    pago: <span>{{
                                      payment_selected.id }}</span>?</h3>
                                </div>
                                <div class="m-t-20"> <a href="javascript:void(0);"
                                    class="btn btn-secondary me-1 text-white w-25" data-bs-dismiss="modal">Cerrar</a>
                                  <button type="submit" class="btn btn-danger w-25"
                                    (click)="deleteAppointmentPay(data)">Eliminar</button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <!-- Fin modal delete -->
                      </td>
                    </tr>

                    <!-- Modal Agregar Pago -->
                    <div [attr.id]="'add_payment-'+data.id" class="modal fade delete-modal" role="dialog">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-body text-center">

                            <div class="row">
                              <div class="col-12 col-md-12 col-xl-6">
                                <div class="form-group local-forms">
                                  <label for="department">MÃ©todo de Pago <span class="login-danger">*</span></label>
                                  <mat-select [(ngModel)]="method_payment" [ngModelOptions]="{standalone: true}"
                                    class="form-control select" placeholder="Seleccione  MÃ©todo">
                                    <mat-option value="Efectivo">
                                      Efectivo
                                    </mat-option>
                                    <mat-option value="Transferencia">
                                      Transferencia
                                    </mat-option>
                                    <mat-option value="MercadoPago">
                                      MercadoPago
                                    </mat-option>
                                    <mat-option value="Tarjeta Debito">
                                      Tarjeta Debito
                                    </mat-option>
                                    <mat-option value="Tarjeta CrÃ©dito">
                                      Tarjeta CrÃ©dito
                                    </mat-option>
                                  </mat-select>
                                </div>
                              </div>

                              <div class="col-12 col-md-12 col-xl-6">
                                <div class="form-group local-forms">
                                  <label for="education">Monto de Adelanto <span class="login-danger">*</span></label>
                                  <input class="form-control" type="number" [(ngModel)]="amount_add" name="amount_add">
                                </div>
                              </div>

                              <div class="col-12 my-2">
                                <!-- ValidaciÃ³n -->
                                <div class="form-group row d-flex justify-content-center" *ngIf="text_success">
                                  <div class="col-12">
                                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                                      <strong>Ãxito!</strong> {{ text_success }}.
                                      <button type="button" class="btn-close" data-bs-dismiss="alert"
                                        aria-label="Close">
                                        <span aria-hidden="true"> </span>
                                      </button>
                                    </div>
                                  </div>
                                </div>

                                <div class="form-group row d-flex justify-content-center" *ngIf="text_validation">
                                  <div class="col-12">
                                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                      <strong>Cuidado!</strong> {{ text_validation }}.
                                      <button type="button" class="btn-close" data-bs-dismiss="alert"
                                        aria-label="Close">
                                        <span aria-hidden="true"> </span>
                                      </button>
                                    </div>
                                  </div>
                                </div>
                                <!-- Fin validaciÃ³n -->
                              </div>
                            </div>


                            <div class="m-t-20"> <a href="javascript:void(0);"
                                class="btn btn-secondary me-1 text-white w-25" data-bs-dismiss="modal">Cerrar</a>
                              <button type="submit" class="btn btn-primary text-white w-25 mx-4"
                                (click)="addPayment(data)">Guardar</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- Fin Agregar Pago -->
                    <!-- Modal Editar Pago -->
                    <div [attr.id]="'edit_payment-'+data.id" class="modal fade delete-modal" role="dialog">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-body text-center">

                            <div class="row">
                              <div class="col-12 col-md-12 col-xl-6">
                                <div class="form-group local-forms">
                                  <label for="department">MÃ©todo de Pago <span class="login-danger">*</span></label>
                                  <mat-select [(ngModel)]="method_payment" [ngModelOptions]="{standalone: true}"
                                    class="form-control select" placeholder="Seleccione  MÃ©todo">
                                    <mat-option value="Efectivo">
                                      Efectivo
                                    </mat-option>
                                    <mat-option value="Transferencia">
                                      Transferencia
                                    </mat-option>
                                    <mat-option value="MercadoPago">
                                      MercadoPago
                                    </mat-option>
                                    <mat-option value="Tarjeta Debito">
                                      Tarjeta Debito
                                    </mat-option>
                                    <mat-option value="Tarjeta CrÃ©dito">
                                      Tarjeta CrÃ©dito
                                    </mat-option>
                                  </mat-select>
                                </div>
                              </div>

                              <div class="col-12 col-md-12 col-xl-6">
                                <div class="form-group local-forms">
                                  <label for="education">Monto de Adelanto <span class="login-danger">*</span></label>
                                  <input class="form-control" type="number" [(ngModel)]="amount_add" name="amount_add">
                                </div>
                              </div>

                              <div class="col-12 my-2">
                                <!-- ValidaciÃ³n -->
                                <div class="form-group row d-flex justify-content-center" *ngIf="text_success">
                                  <div class="col-12">
                                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                                      <strong>Ãxito!</strong> {{ text_success }}.
                                      <button type="button" class="btn-close" data-bs-dismiss="alert"
                                        aria-label="Close">
                                        <span aria-hidden="true"> </span>
                                      </button>
                                    </div>
                                  </div>
                                </div>

                                <div class="form-group row d-flex justify-content-center" *ngIf="text_validation">
                                  <div class="col-12">
                                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                      <strong>Cuidado!</strong> {{ text_validation }}.
                                      <button type="button" class="btn-close" data-bs-dismiss="alert"
                                        aria-label="Close">
                                        <span aria-hidden="true"> </span>
                                      </button>
                                    </div>
                                  </div>
                                </div>
                                <!-- Fin validaciÃ³n -->
                              </div>
                            </div>


                            <div class="m-t-20"> <a href="javascript:void(0);"
                                class="btn btn-secondary me-1 text-white w-25" data-bs-dismiss="modal">Cerrar</a>
                              <button type="submit" class="btn btn-primary text-white w-25 mx-4"
                                (click)="editPayment(data)">Editar</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- Fin Editar Pago -->

                  </ng-container>

                </tbody>
              </table>

              <!-- Paginado -->
              <div class="table_footer">
                <div class="col-sm-12 col-md-5">
                  <div class="dataTables_info">
                    Mostrando {{ serialNumberArray[0] }} a
                    {{ serialNumberArray[serialNumberArray.length - 1] }} de
                    {{ totalData }} pacientes
                  </div>
                </div>

                <div class="col-sm-12 col-md-7">
                  <div class="pagination_section mx-4">
                    <ul class="pagination">
                      <li class="page-item" [ngClass]="{
                                        disabled: currentPage === 1
                                      }">
                        <a (click)="getMoreData('previous')" class="page-link" href="javascript:void(0);"
                          tabindex="-1">Anterior</a>
                      </li>

                      <ng-container *ngFor="let item of pageNumberArray; let i = index">
                        <li class="page-item" [class.active]="item === currentPage" [ngClass]="
                                          (pageNumberArray[currentPage - 2] > item &&
                                            item !== 1 &&
                                            pageNumberArray.length > 6) ||
                                          (pageNumberArray[currentPage] < item &&
                                            item !== 1 &&
                                            pageNumberArray.length > 6 &&
                                            pageNumberArray.length !== item)
                                            ? 'hide-page-no'
                                            : 'show-page-no'
                                        ">
                          <a (click)="moveToPage(item)" class="page-link" href="javascript:void(0);">
                            {{ item }}
                          </a>
                        </li>
                        <li class="page-item" *ngIf="
                                          i === 0 &&
                                          pageNumberArray.length > 6 &&
                                          currentPage > 2
                                        " [hidden]="currentPage === 1" (click)="moveToPage(currentPage - 2)"
                          (keyup.enter)="moveToPage(currentPage - 2)" tabindex="0">
                          <a class="page-link" href="javascript:void(0);">
                            ...
                          </a>
                        </li>
                        <li *ngIf="
                                          i === pageNumberArray.length - 2 &&
                                          pageNumberArray.length > 6
                                        " [hidden]="
                                          currentPage >=
                                            pageNumberArray[pageNumberArray.length - 2] ||
                                          totalData <
                                            serialNumberArray[serialNumberArray.length - 1]
                                        " class="page-item" (click)="moveToPage(currentPage + 2)"
                          (keyup.enter)="moveToPage(currentPage + 2)" tabindex="0">
                          <a class="page-link" href="javascript:void(0);">
                            ...
                          </a>
                        </li>
                      </ng-container>

                      <li class="page-item" [ngClass]="{
                                        disabled:
                                          currentPage ===
                                            pageNumberArray[pageNumberArray.length - 1] ||
                                            appointmentList.length === 0
                                      }">
                        <a (click)="getMoreData('next')" class="page-link" href="javascript:void(0);">Siguiente
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <!-- Fin paginado -->

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- <td class="text-end">
  <div class="dropdown dropdown-action">
    <a href="javascript:void(0);" class="action-icon dropdown-toggle" data-bs-toggle="dropdown"
      aria-expanded="false"><i class="fa fa-ellipsis-v"></i></a>
    <div class="dropdown-menu dropdown-menu-end">
      <a class="dropdown-item" [routerLink]="[ '/appointment-m/list/edit/', data.id ]"><i
          class="fa-solid fa-pen-to-square m-r-5"></i> Editar</a>
      <a class="dropdown-item" href="javascript:void(0);" (click)="deleteAppointmentPay(data)"
        data-bs-toggle="modal" [attr.data-bs-target]="'#delete_staff-'+data.id"><i
          class="fa fa-trash-alt m-r-5"></i> Eliminar</a>
    </div>
  </div>
</td> -->

<!-- Modal delete -->
<!-- <div [attr.id]="'delete_staff-'+data.id" class="modal fade delete-modal" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img src="assets/img/sent.png" alt="" width="50" height="46">
        <div class="modal-body d-flex">
          <h3 *ngIf="appointment_selected" class="text-wrap">Â¿EstÃ¡s segura de que quieres eliminar
            esta
            cita: <span>{{
              appointment_selected.id }}</span>?</h3>
        </div>
        <div class="m-t-20"> <a href="javascript:void(0);"
            class="btn btn-secondary me-1 text-white w-25" data-bs-dismiss="modal">Cerrar</a>
          <button type="submit" class="btn btn-danger w-25">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
</div> -->
<!-- Fin modal delete -->